<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <title>Twitch自動發話給GP</title>
    <link rel="icon" href="start.gif" type="image/gif" />
    <link rel="stylesheet" href="https://marsantony.github.io/shared/nav.css">
    <style>body { padding-top: 56px; }

        #showExcelImage > img {
            display: none;
        }

        #showExcelImage:hover > img {
            display: block;
            position: absolute;
            z-index: 10;
        }
    </style>
</head>

<body>
    <form>
        <div class="mx-auto col-10 col-md-8 col-lg-6">
            <br />
            <br />

            <div class="form-group">
                <label for="username">使用者帳號</label>
                <input type="text" id="username" class="form-control" required />
            </div>
            <div class="form-group">
                <label for="password">OAuth密碼</label>
                <br />
                <a href="https://twitchtokengenerator.com/" class="link-info" target="_blank">Twitch取得oauth password</a>-選Bot Chat Token，然後複製ACCESS TOKEN
                <br />
                前面要加上oauth:{ACCESS TOKEN} => 例如：oauth:ABCDEF123456
                <input type="password" id="password" class="form-control" required />
            </div>

            <div class="form-group">
                <label style="color:red">※GP固定3000</label>
                <br />
                <label for="gameName">載入忠誠點數換GP列表Excel</label>
                <i class="bi bi-info-circle" id="showExcelImage"><img src="./images/LoadExcel.jpg" width="300" /></i>
                <input type="file" id="fileExcel" class="form-control" required />

            </div>

            <br />


            <div class="form-group" style="text-align:right;">
                <div class="row">
                    <div class="col-9"></div>
                    <div class="accordion col-3">
                        <div class="accordion-item">

                            <div id="collapseOne" class="accordion-collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <a href="https://youtu.be/TsGoplqJPYI" class="link-info" target="_blank"><i class="bi bi-film">開始自動發話 教學</i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <br />
                <input type="button" id="autoSend" class="btn btn-primary" value="開始自動發話" />
                <input type="button" id="complete" class="btn btn-success" value="完成" disabled style="display:none;" />
                <input type="button" id="processing" class="btn btn-danger" value="處理中" disabled style="display:none;" />

            </div>
            <br />

            <div class="form-group">
                <label for="log">回覆的LOG：</label>
                <textarea id="log" class="form-control" rows="10" style="resize: none;" readonly></textarea>
            </div>
        </div>
    </form>

    <div class="container">
        <footer class="py-3">
            <hr />
            <div class="row">
                <div class="col-12">
                    <small><a href="https://www.flaticon.com/free-animated-icons/on" title="on animated icons">On animated icons created by Freepik - Flaticon</a></small>
                </div>
            </div>
        </footer>
    </div>


    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script src="./js/tmi.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    

    <script src="https://marsantony.github.io/shared/shared.js"></script>
    <script>
        var XLSX_Data = [];
        function addLog(message) {
            var logEl = document.getElementById('log');
            logEl.value = message + '\r\n' + logEl.value;
        }

         function downloadXLSXFile(data) {
             var now = moment().format('YYYYMMDDHHmmss');
             var worksheet = XLSX.utils.json_to_sheet(data);
             var workbook = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(workbook, worksheet, 'GP發送');

             var fileName = `${now}_GP發送列表.xlsx`;
             XLSX.writeFile(workbook, fileName);
         }

        document.getElementById('fileExcel').addEventListener('change', function(e) {
            var file = e.target.files[0];
            var reader = new FileReader();

            reader.onload = function(e) {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, {type: 'array'});

                var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                var jsonData = XLSX.utils.sheet_to_json(firstSheet);

                XLSX_Data = jsonData;
                addLog(JSON.stringify(jsonData, null, 2));
            };

            reader.readAsArrayBuffer(file);

        });

    </script>

    <script>
        const GGPCOMMAND = 'ggp';
        const GPAMOUNT = '3000';
        const LOCALSTORAGE_USERNAME = 'Twitch_AutoSendMessage_UserName';
        const LOCALSTORAGE_PASSWORD = 'Twitch_AutoSendMessage_Password';

        //將預設值帶入
        document.getElementById('username').value = localStorage.getItem(LOCALSTORAGE_USERNAME) || '';
        document.getElementById('password').value = localStorage.getItem(LOCALSTORAGE_PASSWORD) || '';

        class autoSendMessageClass {
           
            #channels;
            #client;

            constructor(options) {
                if (!options || !options.autoSendButtonName ||
                    !options.completeButtonName || !options.processingButtonName ||
                    !options.sendMessage || typeof options.sendMessage !== 'function') {
                    return;
                }

                this.autoSendButtonName = options.autoSendButtonName;
                this.completeButtonName = options.completeButtonName;
                this.processingButtonName = options.processingButtonName;
                this.sendMessage = options.sendMessage;
            }

            #connect() {
                this.#client = new tmi.Client({
                    options: {
                        debug: false,
                        skipMembership: true, // 不接收 JOIN/PART 訊息
                        skipUpdatingEmotesets: true,
                    },
                    connection: {
                        reconnect: true,
                        secure: true
                    },
                    identity: {
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    },
                    channels: this.#channels
                });

                this.#client.connect().catch(console.error);
            }

            #showProcessing() {
                document.getElementById(this.autoSendButtonName).style.display = 'none';
                document.getElementById(this.completeButtonName).style.display = 'none';
                document.getElementById(this.processingButtonName).style.display = '';
            }

            #showComplete() {
                document.getElementById(this.autoSendButtonName).style.display = 'none';
                document.getElementById(this.completeButtonName).style.display = '';
                document.getElementById(this.processingButtonName).style.display = 'none';
            }


            init() {

                document.getElementById(this.autoSendButtonName).addEventListener('click', (e) => {
                    let form = document.getElementsByTagName('form')[0];
                    if(!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    if(!XLSX_Data || !Array.isArray(XLSX_Data) || XLSX_Data.length == 0) {
                        addLog('Excel未載入成功或沒有資料');
                        return;
                    }
                    
                    this.#channels = [document.getElementById('username').value];

                    this.#showProcessing();
                    if (!this.#client)
                        this.#connect();

                    //將預設值寫入localStorage
                    localStorage.setItem(LOCALSTORAGE_USERNAME, document.getElementById('username').value);
                    localStorage.setItem(LOCALSTORAGE_PASSWORD, document.getElementById('password').value);


                    let accounts = XLSX_Data.map((obj) => Object.values(obj)[0]);
                    let givenAccounts = [];
                    this.#client.on('join', () => {
                        accounts.forEach((account, index) => {
                            let message = this.sendMessage(account, GPAMOUNT);
                            setTimeout(() => { this.#client.say(`${this.#channels[0]}`, message); }, 3000 * index);
                        });
                    });
                      
                    this.#client.on('message', (channel, tags, message, self) => {
                        if (!self || !message.startsWith('!')) return;

                        const args = message.slice(1).split(' ');
                        const command = args.shift();
                        if (args.length < 2 || command !== GGPCOMMAND) return;

                        const account = args.shift();

                        let accountIndex = accounts.includes(account);
                        givenAccounts.push({'已給帳號':account, '是否在原本的EXCEL':accountIndex > -1 ? 'V' : ''});

                        var name = tags['display-name'] ? `${tags['display-name']}(${tags['username']})` : tags['username'];
                        var timeStamp = moment().format('YYYY/MM/DD HH:mm:ss');
                        addLog(`${timeStamp} ${name}，發話：${message}`);

                        if(givenAccounts.length == accounts.length) {
                            downloadXLSXFile(givenAccounts);
                            this.#showComplete();
                        }
                    });

                    
                });
            }
        };

       
        new autoSendMessageClass({
            autoSendButtonName: 'autoSend',
            completeButtonName: 'complete',
            processingButtonName: 'processing',
            sendMessage: function (account, gpAmount) {
                return `!${GGPCOMMAND} ${account} ${gpAmount}`;
            }
        }).init();





    </script>
</body>

</html>